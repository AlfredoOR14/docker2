pipeline {
    agent any
    environment {
        registry='053546436729.dkr.ecr.us-east-1.amazonaws.com' // Reemplaza con la URL de tu ECR
        region='us-east-1' // Reemplaza con la regi√≥n de tu ECR
        nombreTag = "${BUILD_NUMBER}"
        tag = "my-ecr-repository"
        dockerImage = ''
    }
    stages {
        stage('Generando imagen') {
            steps{
                script {
                    dockerImage = docker.build(tag + ":${BUILD_NUMBER}")
                }
            }
        }
        stage('Subiendo imagen a ECR') {
            steps {
                script {
                   withCredentials([string(credentialsId: 'AWS_KEY_ID', variable: 'AWS_KEY_ID'),
                                 string(credentialsId: 'AWS_SECRET_KEY_ID', variable: 'AWS_SECRET_KEY_ID')]) { 
                        sh "aws ecr get-login-password --region ${region} | docker login --username AWS --password-stdin ${registry}"
                        dockerImage.push()
                        dockerImage.push("latest")
                    }
                }
            }
        }
        stage('Limpiando el entorno') {
            steps{
                sh 'docker rmi $tag:$BUILD_NUMBER'
                sh 'docker rmi $registry/$tag:$BUILD_NUMBER'
                sh 'docker rmi $registry/$tag:latest'
            }
        }
    }
}


